# Order & Delivery Workflow

## Полный цикл заказа от подписки до доставки

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        SUBSCRIPTION ORDER FLOW                               │
└─────────────────────────────────────────────────────────────────────────────┘

[Клиент]                    [API]                      [Склад]     [Доставщик]
   │                          │                           │            │
   │  1. Оформляет подписку   │                           │            │
   │─────────────────────────>│                           │            │
   │                          │                           │            │
   │  2. Оплачивает           │                           │            │
   │─────────────────────────>│                           │            │
   │                          │                           │            │
   │                          │  3. Подписка АКТИВНА      │            │
   │                          │  (SubscriptionScheduler)  │            │
   │                          │                           │            │
   │◄─────────────────────────│                           │            │
   │  Подтверждение           │                           │            │

─────────────────────────────────────────────────────────────────────────────
                              [НОЧЬЮ / 6:00 AM]
                              CRON JOB запускается
─────────────────────────────────────────────────────────────────────────────

   │                          │                           │            │
   │                          │  4. Генерация заказа      │            │
   │                          │  createDeliveryOrder()    │            │
   │                          │                           │            │
   │                          │──────────────────────────>│            │
   │                          │  Заказ в статусе          │            │
   │                          │  PENDING                  │            │
   │                          │                           │            │
   │◄─────────────────────────│  5. Уведомление клиенту   │            │
   │  "Завтра доставка!"      │                           │            │
   │                          │                           │            │

─────────────────────────────────────────────────────────────────────────────
                              [УТРО / РАБОЧИЙ ДЕНЬ]
─────────────────────────────────────────────────────────────────────────────

   │                          │                           │            │
   │                          │                           │  6. Склад  │
   │                          │                           │  подтверждает
   │                          │                           │  POST      │
   │                          │                           │  /:id/confirm
   │                          │                           │            │
   │                          │                           │  Статус:   │
   │                          │                           │  CONFIRMED │
   │                          │                           │            │
   │                          │                           │  7. Комплек-
   │                          │                           │  тация     │
   │                          │                           │  POST      │
   │                          │                           │  /start-   │
   │                          │                           │  packing   │
   │                          │                           │            │
   │                          │                           │  Статус:   │
   │                          │                           │  PACKING   │
   │                          │                           │            │
   │                          │                           │  8. Готов  │
   │                          │                           │  POST      │
   │                          │                           │  /ready    │
   │                          │                           │            │
   │                          │                           │  Статус:   │
   │                          │                           │  READY     │
   │                          │                           │            │
   │                          │  9. Назначение            │            │
   │                          │  доставщика               │            │
   │                          │  POST /assign-driver      │            │
   │                          │───────────────────────────────────────>│
   │                          │                           │            │
   │                          │                           │            │  Статус:
   │                          │                           │            │  ASSIGNED
   │◄─────────────────────────│                           │            │
   │  Уведомление:            │                           │            │
   │  "Заказ в пути"          │                           │            │
   │                          │                           │            │

─────────────────────────────────────────────────────────────────────────────
                              [ДОСТАВКА]
─────────────────────────────────────────────────────────────────────────────

   │                          │                           │            │
   │                          │                           │            │  10. Забрал
   │                          │                           │            │  POST
   │                          │                           │            │  /:id/pickup
   │                          │                           │            │
   │                          │                           │            │  Статус:
   │                          │                           │            │  IN_TRANSIT
   │                          │                           │            │
   │                          │                           │            │  11. Маршрут
   │                          │  GET /driver/orders/route │            │
   │                          │  Оптимизированный путь    │            │
   │                          │<────────────────────────────────────────│
   │                          │                           │            │
   │                          │                           │            │
   │                          │                           │            │  12. Доставил
   │                          │                           │            │  POST
   │                          │                           │            │  /:id/deliver
   │                          │                           │            │  + фото/подпись
   │                          │                           │            │
   │                          │                           │            │  Статус:
   │                          │                           │            │  DELIVERED
   │                          │                           │            │
   │                          │  13. Обновление           │            │
   │                          │  подписки                 │            │
   │                          │  completeDelivery()       │            │
   │                          │  deliveriesCompleted++    │            │
   │                          │                           │            │
   │◄─────────────────────────│                           │            │
   │  "Спасибо! Следующая     │                           │            │
   │   доставка: ..."         │                           │            │
   │                          │                           │            │
```

## Статусы заказа (OrderStatus)

| Статус | Описание | Действие |
|--------|----------|----------|
| `PENDING` | Ожидает обработки | Заказ создан автоматически, ждет склада |
| `CONFIRMED` | Подтвержден | Склад принял заказ |
| `PACKING` | Комплектуется | Собирается товар |
| `READY` | Готов к выдаче | Упакован, ждет доставщика |
| `ASSIGNED` | Назначен курьер | Закреплен за доставщиком |
| `IN_TRANSIT` | В пути | Доставщик забрал заказ |
| `DELIVERED` | Доставлен | Фото + подпись получены |
| `CANCELLED` | Отменен | Заказ отменен |

## API Endpoints

### Warehouse (Склад)
```
GET    /warehouse/orders/today          # Заказы на сегодня
POST   /warehouse/orders/:id/confirm    # Подтвердить заказ
POST   /warehouse/orders/:id/start-packing  # Начать комплектацию
POST   /warehouse/orders/:id/ready      # Заказ готов
POST   /warehouse/orders/:id/assign-driver  # Назначить доставщика
GET    /warehouse/orders/stats/today    # Статистика за день
```

### Driver (Доставщик)
```
GET    /driver/orders/my                # Мои заказы
GET    /driver/orders/route             # Оптимизированный маршрут
POST   /driver/orders/:id/pickup        # Забрал заказ
POST   /driver/orders/:id/deliver       # Доставил (+фото/подпись)
POST   /driver/orders/:id/failed        # Неудача (перезаказ)
GET    /driver/orders/stats/today       # Моя статистика
```

### Subscription Scheduler
```
# Автоматически каждый день в 6:00 AM (Cron)
# Или вручную:
POST   /subscriptions/:id/generate-order  # Создать заказ вручную
```

## Order Code Format

```
Подписка: SUB-240215-A3F7
Заказы:   SUB-240215-A3F7-D1  (доставка 1)
          SUB-240215-A3F7-D2  (доставка 2)
          SUB-240215-A3F7-D3  (доставка 3)
```

## Уведомления

| Событие | Получатель | Содержание |
|---------|------------|------------|
| Заказ создан (за день) | Клиент | "Завтра доставка!" |
| Назначен курьер | Клиент | Имя, телефон курьера |
| Курьер в пути | Клиент | "Заказ в пути" |
| Доставлено | Клиент | "Спасибо! Следующая: ..." |
| Новый заказ | Склад | Код заказа, приоритет |
| Назначение | Курьер | Адрес, телефон клиента |

## Mobile App Views

### Driver App (Flutter)
- **Route Screen**: Карта с маршрутом, список точек
- **Order Detail**: Адрес, телефон, комментарий, кнопки действий
- **Delivery Complete**: Камера для фото, canvas для подписи
- **Stats**: Выполнено/всего, заработок за день

### Warehouse App (Web/Tablet)
- **Dashboard**: Статистика, заказы по статусам
- **Order List**: Фильтры, поиск, приоритеты
- **Packing Screen**: Сканер штрих-кодов, чек-лист товаров
- **Driver Assignment**: Список курьеров, распределение

## Интеграции

### Telegram Bot (Уведомления)
```typescript
// Подтверждение доставки клиенту
await notifications.sendDeliveryConfirmation({
    customerTelegramId: customer.telegramId,
    orderCode: 'SUB-240215-A3F7-D1',
    deliveredAt: new Date(),
    nextDeliveryDate: new Date('2024-02-22'),
});
```

### Map/Routing (опционально)
```typescript
// Оптимизация маршрута
const route = await yandexService.buildRoute({
    points: orders.map(o => ({ lat: o.lat, lng: o.lng })),
    optimize: true,
});
```
